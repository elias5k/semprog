/**
* Kerv Overlay
* hotfix/24.3
* 1/7/2022, 9:48:48 AM
*/
"use strict";window.kervEmbed={plugin:null,loadCallback:function(){},token:null,primaryContainer:null,debounce:{},contentMap:{100:100},scriptLoaded:!1,videoSet:!1,virtualSlot:!1,dataEnv:"prod",env:"prod",videContainer:null,loadOverlay:function(e,t){if(!this.token)return console.log("KERV ERROR: this token is not active"),!1;var n=this,o=new XMLHttpRequest;o.open("GET","https://bcdn.grabitinteractive.com/embed-cache/"+n.token+".json",!0),o.onload=function(){if(o.status>=200&&o.status<400){n.contentMap=JSON.parse(o.responseText),console.log("KERV: Cache Read Success");var i=e.toString();i in n.contentMap&&(e=n.contentMap[i]),n.loadOverlay3(i,e,t)}else console.log("KERV: Cache Response Error")},o.onerror=function(){console.log("KERV: Cache Request Error")},o.send()},setVideoElement:function(e){var t=null;t="string"==typeof e?e.startsWith("#")?document.querySelectorAll(e)[0]:document.getElementById(e):e,console.debug("Kerv **** contElem",t);var n=t.getElementsByTagName("video");console.debug("Kerv **** videoNodeList",n);for(let e=0;e<n.length;e++)if(console.debug("kerv",e,n[e].hasAttribute("src"),n[e]),n[e].hasAttribute("src"))return void(this.videContainer=n.item(e));this.videContainer||console.error("KERV: could not find a video element")},loadOverlay3:async function(e,t,n){if(!this.checkOverlay(e))return console.log("KERV ERROR: this content is not interactive"),!1;"#bmpui-id-48"==n&&(n=".organism .bitmovinplayer-container"),this.primaryContainer=n;var o=document.querySelectorAll(n+" video");if(o)if(o.addEventListener)o.addEventListener("pause",this.removePlayerPauseUI),o.addEventListener("play",this.removePlayerPlayUI),this.videoSet=!1;else if(o[0]&&o[0].addEventListener){var i=this.videoLibrary(o[0]);i&&(i.controls.style.zIndex="1001"),o[0].addEventListener("pause",this.removePlayerPauseUI),o[0].addEventListener("play",this.removePlayerPlayUI),this.videoSet=!0}if(document.onfullscreenchange=this.fullscreenHandler,this.debounce.hasOwnProperty(n))return console.log("KERV ERROR: this container has already loaded the overlay - "+n),!0;var r=document.querySelectorAll(n);if(!(r=r[0]))return console.log("KERV ERROR: Container does not exist -> selector: "+n),!1;this.videoSet||(this.virtualSlot=document.createElement("video"),this.virtualSlot.style.width="0px",this.virtualSlot.style.height="0px",r.appendChild(this.virtualSlot)),this.removeOverlay(),this.debounce[n]=1;var l=this;console.log("KERV: Attaching to container - "+n);var s="kerv-video-container",a='<div style="width:100%;height:100%;position:absolute;top:0px;left:0px;z-index:1;" id="'+s+'"></div>',c=document.querySelectorAll(n+" .bmpui-ui-controlbar");(c=c[0])&&(c.classList.remove("bmpui-hidden"),c.style["z-index"]="1000");var d=document.querySelectorAll(l.primaryContainer+" .bmpui-ui-playbacktoggle-overlay");this.removePlayerUI();var u=document.createElement("div");u.innerHTML=a.trim(),a=u.firstChild,r.insertBefore(a,r.firstChild),document.getElementById(s).addEventListener("mouseover",(function(e){c&&(c.classList.remove("bmpui-hidden"),c.style["z-index"]="1000"),d&&(d.style?d.style.display="none !important":d[0]&&d[0].style&&(d[0].style.display="none !important"))}),!1);var v=function(){l.scriptLoaded=!0,l.setVideoElement(l.primaryContainer);var e=l.videContainer?l.videContainer:o[0];console.debug("Kerv: using video element",e),l.O3.load(s,t,e,l.dataEnv),l.plugin=l.O3.getEventTarget(),setTimeout((function(){l.loadCallback(),"01E9ERDZS5126Y33M7BY8C7W2R"==l.token&&(window.kervEmbed.O3.setSetting("nobgclick",!0),window.kervEmbed.O3.setSetting("cta",!0),window.kervEmbed.O3.setSetting("shopscroll",!0)),"01DN3MNEC8MG37HT4DH7FF14MC"==l.token&&(window.kervEmbed.O3.setSetting("nobgclick",!0),window.kervEmbed.O3.setSetting("shopscroll",!0))}),200)};if(l.scriptLoaded)console.log("KERV: Skipping Player Script"),v();else{var h=l.env?"https://rcdn.kervinteractive.com/overlay/v3/"+l.env+"/kerv-embed.js":"http://localhost:5000/kerv-embed.js";console.log("KERV: Loading Player Script"),l.scriptLoader([h],v)}},removePlayerUI:function(){var e=this,t=document.querySelectorAll(e.primaryContainer+" .bmpui-ui-playbacktoggle-overlay");t?t.style?t.style.display="none":t[0]&&t[0].style?t[0].style.display="none":setTimeout((function(){e.removePlayerUI()}),100):setTimeout((function(){e.removePlayerUI()}),100)},removePlayerPauseUI:function(){},removePlayerPlayUI:function(e){},fullscreenHandler:function(){var e=window.kervEmbed;console.log("KERV: fullscreenHandler");var t=document.querySelectorAll(e.primaryContainer+" video");t.addEventListener?(t.play(),t.paused&&e.showResumeButton()):t[0]&&t[0].addEventListener&&(t[0].play(),t[0].paused&&e.showResumeButton())},showResumeButton:function(){},disableOverlayClick:function(e){},enableOverlayClick:function(e){},checkOverlayClick:function(){},init:function(e){return console.log("KERV: Setting API Token --\x3e "+e),this.token=e,!0},cleanup:function(e){console.log("KERV: Cleanup")},onLoad:function(e){this.loadCallback=e},removeOverlay:function(){console.log("KERV: removeOverlay call");var e=document.getElementById("kerv-video-container");this.O3&&this.O3.isLoaded()&&this.O3.destroy(),e&&(e.length?e.forEach((function(t,n){t.parentNode.removeChild(t),e.length===n&&(this.destroy(),this.debounce={})})):(e.parentNode.removeChild(e),this.destroy(),this.debounce={}))},updateOverlay:function(e){console.debug("kerv: request update",e);var t=e.toString();t in this.contentMap?(e=this.contentMap[t],this.plugin=this.O3.getEventTarget(),this.O3.update(e)):console.log("KERV: This content is not interactive")},checkOverlay:function(e){return console.log("KERV: Check Overlay --\x3e "+e),!!this.getInteractiveIds().includes(e)},getInteractiveIds:function(){return Object.keys(this.contentMap)},addEventListener:function(e,t){this.plugin.addEventListener(e,t)},removeEventListeners:function(e,t){this.plugin.removeEventListeners(e,t)},updateTime:function(e){this.virtualSlot&&(this.virtualSlot.currentTime=e)},destroy:function(){this.disableListeners=!1},scriptLoader:function(e,t){var n=e.length;function o(e){var o=document.createElement("script");o.setAttribute("src",e),o.onload=function(){--n<1&&t()},document.head.appendChild(o)}for(var i of e)o(i)},videoLibrary:function(e){const t={"vjs-tech":{controls:"vjs-control-bar"},"HTMLPlayer-module__video":{controls:"GUI-module__controls"}};if(e){const n=[];if(e.classList.forEach((e=>{t[e]&&n.push(t[e])})),n.length){return{controls:function(t){const n=e.parentNode.getElementsByClassName(t);return n.length?n[0]:null}(n[0].controls)}}}return null}};
